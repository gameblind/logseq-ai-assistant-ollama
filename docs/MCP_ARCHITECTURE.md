# Logseq AI Assistant MCP 架构设计

## 问题分析

### Logseq 插件沙盒限制

基于研究发现，Logseq插件运行在严格的沙盒环境中：

1. **网络访问限制**：插件只能通过预定义的API进行网络请求，无法直接创建TCP/WebSocket连接
2. **进程隔离**：插件运行在iframe或shadow DOM中，无法启动外部进程或服务
3. **文件系统限制**：只能访问图谱内容，无法访问系统文件或启动本地服务
4. **消息传递机制**：所有与主应用的交互都通过消息传递系统进行

### MCP 集成挑战

- MCP需要客户端-服务器架构，需要建立持久连接
- 需要能够动态加载和配置外部服务
- 需要处理复杂的工具调用和资源访问

## 新架构设计：代理桥接模式

### 架构概览

```
┌─────────────────────────────────────┐
│           Logseq 应用               │
│  ┌─────────────────────────────┐    │
│  │      AI Assistant 插件      │    │
│  │                             │    │
│  │  ┌─────────────────────┐    │    │
│  │  │   MCP Client UI     │    │    │
│  │  └─────────────────────┘    │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
              │ HTTP/WebSocket
              ▼
┌─────────────────────────────────────┐
│        本地桥接服务                 │
│     (Local Bridge Service)          │
│                                     │
│  ┌─────────────────────────────┐    │
│  │      MCP 客户端管理器       │    │
│  │                             │    │
│  │  ┌─────────────────────┐    │    │
│  │  │   配置管理          │    │    │
│  │  └─────────────────────┘    │    │
│  │  ┌─────────────────────┐    │    │
│  │  │   连接池管理        │    │    │
│  │  └─────────────────────┘    │    │
│  │  ┌─────────────────────┐    │    │
│  │  │   工具调用路由      │    │    │
│  │  └─────────────────────┘    │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
              │ MCP Protocol
              ▼
┌─────────────────────────────────────┐
│          MCP 服务生态               │
│                                     │
│  ┌─────────────┐  ┌─────────────┐   │
│  │图片搜索服务 │  │文件处理服务 │   │
│  └─────────────┘  └─────────────┘   │
│  ┌─────────────┐  ┌─────────────┐   │
│  │数据库服务  │  │API集成服务  │   │
│  └─────────────┘  └─────────────┘   │
└─────────────────────────────────────┘
```

### 核心组件

#### 1. Logseq 插件层 (现有插件扩展)

**功能**：
- 提供MCP服务配置界面
- 处理用户命令输入
- 与本地桥接服务通信
- 展示MCP工具执行结果

**技术实现**：
- 扩展现有的设置系统，添加MCP配置
- 新增MCP命令处理器
- 通过HTTP API与桥接服务通信

#### 2. 本地桥接服务 (新建独立应用)

**功能**：
- 作为Logseq插件与MCP服务器之间的代理
- 管理MCP客户端连接
- 处理工具调用和资源访问
- 提供RESTful API供插件调用

**技术栈**：
- Node.js + Express (轻量级HTTP服务)
- MCP TypeScript SDK
- WebSocket支持
- 配置文件管理

#### 3. MCP 服务配置系统

**配置文件结构**：
```json
{
  "mcpServices": [
    {
      "id": "image-search",
      "name": "图片搜索服务",
      "type": "stdio",
      "command": "python",
      "args": ["-m", "image_search_server"],
      "env": {
        "API_KEY": "${UNSPLASH_API_KEY}"
      },
      "tools": [
        {
          "name": "search_images",
          "description": "搜索图片",
          "logseqCommand": "/gpt-photo"
        }
      ]
    }
  ]
}
```

### 实现步骤

#### 阶段1：桥接服务开发

1. **创建独立的Node.js应用**
   - 初始化项目结构
   - 集成MCP TypeScript SDK
   - 实现基础HTTP服务器

2. **MCP客户端管理**
   - 连接池管理
   - 服务发现和注册
   - 错误处理和重连机制

3. **API设计**
   ```typescript
   // 获取可用服务
   GET /api/mcp/services
   
   // 调用工具
   POST /api/mcp/tools/{serviceId}/{toolName}
   {
     "arguments": {...}
   }
   
   // 获取资源
   GET /api/mcp/resources/{serviceId}/{resourceUri}
   
   // 配置管理
   GET/POST/PUT/DELETE /api/mcp/config
   ```

#### 阶段2：插件集成

1. **扩展设置系统**
   - 添加MCP服务配置界面
   - 桥接服务连接设置
   - 服务状态监控

2. **命令系统扩展**
   - 动态注册MCP工具命令
   - 统一的命令处理流程
   - 结果格式化和展示

3. **通信层实现**
   - HTTP客户端封装
   - 错误处理和用户反馈
   - 缓存和性能优化

#### 阶段3：MCP服务开发

1. **图片搜索服务** (实现 `/gpt-photo` 命令)
   ```python
   # image_search_server.py
   from mcp.server import Server
   import requests
   
   server = Server("image-search")
   
   @server.tool("search_images")
   async def search_images(query: str, count: int = 5):
       # 调用Unsplash API或其他图片搜索服务
       results = await search_unsplash(query, count)
       return {
           "images": [
               {
                   "url": img["urls"]["regular"],
                   "description": img["description"],
                   "author": img["user"]["name"]
               }
               for img in results
           ]
       }
   ```

2. **其他扩展服务**
   - 文件处理服务
   - 数据库查询服务
   - API集成服务

### 优势分析

#### 1. 绕过沙盒限制
- 桥接服务运行在系统级别，不受插件沙盒限制
- 可以建立任意网络连接和启动外部进程
- 插件只需通过HTTP API通信，符合沙盒安全模型

#### 2. 配置驱动的扩展
- 用户可以通过配置文件添加新的MCP服务
- 无需修改插件代码即可扩展功能
- 支持热重载和动态配置更新

#### 3. 标准化和生态兼容
- 完全兼容MCP协议标准
- 可以使用现有的MCP服务和工具
- 为Logseq生态系统提供标准化的扩展机制

#### 4. 安全性和隔离
- 桥接服务提供额外的安全层
- 可以实现细粒度的权限控制
- 服务间隔离，避免相互影响

### 部署和使用

#### 安装流程
1. 安装桥接服务 (独立可执行文件或npm包)
2. 启动桥接服务 (后台运行)
3. 在Logseq中配置桥接服务地址
4. 通过配置文件添加MCP服务

#### 用户体验
- 一次配置，持久使用
- 图形化配置界面
- 实时状态监控
- 错误诊断和修复建议

### 技术风险和缓解

#### 风险
1. **额外的系统依赖**：需要运行独立的桥接服务
2. **网络通信延迟**：插件与桥接服务间的HTTP通信
3. **配置复杂性**：用户需要理解MCP服务配置

#### 缓解措施
1. **简化部署**：提供一键安装脚本和图形化安装程序
2. **性能优化**：实现连接池、缓存和批量请求
3. **用户友好**：提供配置向导和预设模板

## 结论

这个代理桥接架构设计能够有效绕过Logseq插件的沙盒限制，同时保持MCP协议的标准化优势。通过将复杂的MCP客户端逻辑移到独立的桥接服务中，我们可以实现真正的配置驱动扩展，让用户无需编程即可为Logseq添加强大的新功能。

下一步将开始实现桥接服务的核心功能，并逐步集成到现有的插件架构中。